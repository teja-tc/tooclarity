'use client';

import React, { useEffect, useRef, useState } from 'react';
import { useRouter, usePathname } from 'next/navigation';
import styles from './HomeHeader.module.css';

interface HomeHeaderProps {
  userName: string;
  userAvatar?: string;
  searchValue?: string;
  onFilterClick?: () => void;
  onNotificationClick?: () => void;
  onWishlistClick?: () => void;
  onSearchChange?: (query: string) => void;
  onProfileClick?: () => void;
}

export const HomeHeader: React.FC<HomeHeaderProps> = ({
  userName,
  userAvatar,
  searchValue = '',
  onFilterClick,
  onNotificationClick,
  onWishlistClick,
  onSearchChange,
  onProfileClick,
}) => {
  const router = useRouter();
  const pathname = usePathname();
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const menuRef = useRef<HTMLDivElement | null>(null);

  const navItems = [
    {
      id: 'home',
      label: 'Home',
      icon: (
        <svg width="18" height="19" viewBox="0 0 18 19" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 8.99931V17.9993C18 18.1982 17.921 18.389 17.7803 18.5296C17.6397 18.6703 17.4489 18.7493 17.25 18.7493H12C11.8011 18.7493 11.6103 18.6703 11.4697 18.5296C11.329 18.389 11.25 18.1982 11.25 17.9993V13.1243C11.25 13.0248 11.2105 12.9295 11.1402 12.8591C11.0698 12.7888 10.9745 12.7493 10.875 12.7493H7.125C7.02554 12.7493 6.93016 12.7888 6.85983 12.8591C6.78951 12.9295 6.75 13.0248 6.75 13.1243V17.9993C6.75 18.1982 6.67098 18.389 6.53033 18.5296C6.38968 18.6703 6.19891 18.7493 6 18.7493H0.75C0.551088 18.7493 0.360322 18.6703 0.21967 18.5296C0.0790178 18.389 0 18.1982 0 17.9993V8.99931C0.000184396 8.60155 0.15834 8.22016 0.439687 7.93899L7.93969 0.438992C8.22096 0.1579 8.60235 0 9 0C9.39765 0 9.77904 0.1579 10.0603 0.438992L17.5603 7.93899C17.8417 8.22016 17.9998 8.60155 18 8.99931Z" fill="#0222D7"/>
        </svg>
      ),
      onClick: () => router.push('/dashboard'),
      path: '/dashboard',
    },
    {
      id: 'explore',
      label: 'Explore',
      icon: (
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18.9881 18.1931L14.1712 13.3762C15.5448 11.7966 16.2514 9.74529 16.1421 7.6548C16.0328 5.56432 15.1161 3.59794 13.5852 2.17016C12.0544 0.742392 10.0289 -0.035227 7.93592 0.00122609C5.8429 0.0376792 3.84579 0.885357 2.36557 2.36557C0.885357 3.84579 0.0376792 5.8429 0.00122609 7.93592C-0.035227 10.0289 0.742392 12.0544 2.17016 13.5852C3.59794 15.1161 5.56432 16.0328 7.6548 16.1421C9.74529 16.2514 11.7966 15.5448 13.3762 14.1712L18.1931 18.9881C18.2997 19.0874 18.4407 19.1415 18.5865 19.139C18.7322 19.1364 18.8712 19.0774 18.9743 18.9743C19.0774 18.8712 19.1364 18.7322 19.139 18.5865C19.1415 18.4407 19.0874 18.2997 18.9881 18.1931ZM1.15308 8.09058C1.15308 6.71847 1.55996 5.37718 2.32226 4.23631C3.08456 3.09545 4.16805 2.20625 5.43571 1.68117C6.70338 1.15608 8.09828 1.0187 9.44402 1.28638C10.7898 1.55407 12.0259 2.2148 12.9961 3.18503C13.9664 4.15525 14.6271 5.3914 14.8948 6.73714C15.1625 8.08288 15.0251 9.47779 14.5 10.7454C13.9749 12.0131 13.0857 13.0966 11.9448 13.8589C10.804 14.6212 9.46269 15.0281 8.09058 15.0281C6.25133 15.0258 4.48804 14.2942 3.18749 12.9937C1.88694 11.6931 1.15531 9.92984 1.15308 8.09058Z" fill="#697282"/>
        </svg>
      ),
      onClick: () => router.push('/student/explore'),
      path: '/student/explore',
    },
    {
      id: 'wishlist',
      label: 'Wishlist',
      icon: (
        <svg width="12" height="16" viewBox="0 0 12 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 15.5V1.6155C0 1.15517 0.154167 0.770833 0.4625 0.4625C0.770833 0.154167 1.15517 0 1.6155 0H10.3845C10.8448 0 11.2292 0.154167 11.5375 0.4625C11.8458 0.770833 12 1.15517 12 1.6155V15.5L6 12.923L0 15.5ZM1 13.95L6 11.8L11 13.95V1.6155C11 1.4615 10.9359 1.32042 10.8077 1.19225C10.6796 1.06408 10.5385 1 10.3845 1H1.6155C1.4615 1 1.32042 1.06408 1.19225 1.19225C1.06408 1.32042 1 1.4615 1 1.6155V13.95Z" fill="#697282"/>
        </svg>
      ),
      onClick: () => router.push('/dashboard'),
      path: null,
    },
    {
      id: 'profile',
      label: 'Profile',
      icon: (
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9.5625 0C7.67122 0 5.82241 0.560831 4.24986 1.61157C2.67732 2.66231 1.45167 4.15577 0.727906 5.90309C0.00414312 7.65041 -0.185226 9.57311 0.183745 11.4281C0.552716 13.283 1.46346 14.9869 2.8008 16.3242C4.13814 17.6615 5.84201 18.5723 7.69695 18.9413C9.5519 19.3102 11.4746 19.1209 13.2219 18.3971C14.9692 17.6733 16.4627 16.4477 17.5134 14.8751C18.5642 13.3026 19.125 11.4538 19.125 9.5625C19.122 7.02728 18.1136 4.59675 16.3209 2.80408C14.5283 1.01141 12.0977 0.00297736 9.5625 0ZM4.26 16.125C4.81012 15.2102 5.58753 14.4534 6.51667 13.9279C7.44581 13.4025 8.49508 13.1263 9.5625 13.1263C10.6299 13.1263 11.6792 13.4025 12.6083 13.9279C13.5375 14.4534 14.3149 15.2102 14.865 16.125C13.3653 17.3411 11.4933 18.0047 9.5625 18.0047C7.63175 18.0047 5.75966 17.3411 4.26 16.125ZM6.375 8.8125C6.375 8.18207 6.56195 7.5658 6.9122 7.04162C7.26244 6.51744 7.76026 6.10889 8.3427 5.86763C8.92514 5.62638 9.56604 5.56326 10.1844 5.68625C10.8027 5.80924 11.3706 6.11282 11.8164 6.5586C12.2622 7.00438 12.5658 7.57234 12.6888 8.19065C12.8117 8.80896 12.7486 9.44986 12.5074 10.0323C12.2661 10.6147 11.8576 11.1126 11.3334 11.4628C10.8092 11.8131 10.1929 12 9.5625 12C8.71713 12 7.90637 11.6642 7.3086 11.0664C6.71083 10.4686 6.375 9.65788 6.375 8.8125ZM15.7041 15.3412C14.8203 13.967 13.4992 12.9306 11.9541 12.3994C12.7245 11.8862 13.3094 11.1387 13.6222 10.2675C13.9351 9.39619 13.9592 8.44739 13.6912 7.56133C13.4231 6.67526 12.877 5.89898 12.1337 5.34726C11.3903 4.79553 10.4892 4.49765 9.56344 4.49765C8.63772 4.49765 7.73656 4.79553 6.99322 5.34726C6.24987 5.89898 5.70379 6.67526 5.43572 7.56133C5.16764 8.44739 5.19181 9.39619 5.50464 10.2675C5.81746 11.1387 6.40235 11.8862 7.17282 12.3994C5.62769 12.9306 4.30663 13.967 3.42282 15.3412C2.29297 14.1423 1.53884 12.6387 1.25348 11.0162C0.968118 9.39363 1.16401 7.72303 1.81698 6.2105C2.46995 4.69797 3.55143 3.40968 4.928 2.50459C6.30456 1.5995 7.91598 1.1172 9.56344 1.1172C11.2109 1.1172 12.8223 1.5995 14.1989 2.50459C15.5755 3.40968 16.6569 4.69797 17.3099 6.2105C17.9629 7.72303 18.1588 9.39363 17.8734 11.0162C17.588 12.6387 16.8339 14.1423 15.7041 15.3412Z" fill="#697282"/>
        </svg>
      ),
      onClick: () => router.push('/student/profile'),
      path: '/student/profile',
    },
  ];

  const isActive = (path: string | null) => {
    if (!path) return false;
    return pathname === path || pathname?.startsWith(path);
  };

  useEffect(() => {
    const handler = (e: MouseEvent) => {
      if (menuRef.current && !menuRef.current.contains(e.target as Node)) {
        setIsMenuOpen(false);
      }
    };
    document.addEventListener('mousedown', handler);
    return () => document.removeEventListener('mousedown', handler);
  }, []);
  const getInitials = (name: string) => {
    return name
      .split(' ')
      .map((n) => n[0])
      .join('')
      .toUpperCase();
  };

  const handleFilterClick = () => {
    onFilterClick?.();
  };

  return (
    <div className={styles.headerContainer}>
      <div className={styles.header}>
        <div className={styles.leftSection}>
          <button
            type="button"
            className={styles.avatar}
            onClick={onProfileClick}
            aria-label="Open profile"
          >
            {userAvatar ? (
              <img src={userAvatar} alt={userName} />
            ) : (
              <span className={styles.initialsText}>{getInitials(userName)}</span>
            )}
          </button>
          <div className={styles.greetingText}>
            <h2 className={styles.greeting}>Welcome back</h2>
            <p className={styles.userName}>{userName} ðŸ‘‹</p>
          </div>
        </div>

        <div className={styles.centerSection}>
          <div className={styles.searchWrapper}>
            <svg
              className={styles.searchIcon}
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
            >
              <circle cx="11" cy="11" r="8" />
              <path d="m21 21-4.35-4.35" />
            </svg>
            <input
              type="text"
              className={styles.searchBar}
              placeholder='"Search courses "'
              value={searchValue}
              onChange={(e) => onSearchChange?.(e.target.value)}
              aria-label="Search courses"
            />
          </div>

          <button
            className={styles.filterBtn}
            title="Filters"
            onClick={handleFilterClick}
            aria-label="Open filters"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6.00002 9.84375V3.75C6.00002 3.55109 5.92101 3.36032 5.78035 3.21967C5.6397 3.07902 5.44894 3 5.25002 3C5.05111 3 4.86035 3.07902 4.71969 3.21967C4.57904 3.36032 4.50002 3.55109 4.50002 3.75V9.84375C3.85471 10.009 3.28274 10.3843 2.87429 10.9105C2.46584 11.4367 2.24414 12.0839 2.24414 12.75C2.24414 13.4161 2.46584 14.0633 2.87429 14.5895C3.28274 15.1157 3.85471 15.491 4.50002 15.6562V20.25C4.50002 20.4489 4.57904 20.6397 4.71969 20.7803C4.86035 20.921 5.05111 21 5.25002 21C5.44894 21 5.6397 20.921 5.78035 20.7803C5.92101 20.6397 6.00002 20.4489 6.00002 20.25V15.6562C6.64533 15.491 7.2173 15.1157 7.62575 14.5895C8.0342 14.0633 8.25591 13.4161 8.25591 12.75C8.25591 12.0839 8.0342 11.4367 7.62575 10.9105C7.2173 10.3843 6.64533 10.009 6.00002 9.84375ZM5.25002 14.25C4.95335 14.25 4.66334 14.162 4.41667 13.9972C4.16999 13.8324 3.97774 13.5981 3.8642 13.324C3.75067 13.0499 3.72097 12.7483 3.77885 12.4574C3.83672 12.1664 3.97958 11.8991 4.18936 11.6893C4.39914 11.4796 4.66642 11.3367 4.95739 11.2788C5.24836 11.2209 5.54996 11.2506 5.82405 11.3642C6.09814 11.4777 6.33241 11.67 6.49723 11.9166C6.66205 12.1633 6.75002 12.4533 6.75002 12.75C6.75002 13.1478 6.59199 13.5294 6.31068 13.8107C6.02938 14.092 5.64785 14.25 5.25002 14.25ZM12.75 5.34375V3.75C12.75 3.55109 12.671 3.36032 12.5304 3.21967C12.3897 3.07902 12.1989 3 12 3C11.8011 3 11.6103 3.07902 11.4697 3.21967C11.329 3.36032 11.25 3.55109 11.25 3.75V5.34375C10.6047 5.50898 10.0327 5.88428 9.62429 6.41048C9.21584 6.93669 8.99414 7.58387 8.99414 8.25C8.99414 8.91613 9.21584 9.56331 9.62429 10.0895C10.0327 10.6157 10.6047 10.991 11.25 11.1562V20.25C11.25 20.4489 11.329 20.6397 11.4697 20.7803C11.6103 20.921 11.8011 21 12 21C12.1989 21 12.3897 20.921 12.5304 20.7803C12.671 20.6397 12.75 20.4489 12.75 20.25V11.1562C13.3953 10.991 13.9673 10.6157 14.3758 10.0895C14.7842 9.56331 15.0059 8.91613 15.0059 8.25C15.0059 7.58387 14.7842 6.93669 14.3758 6.41048C13.9673 5.88428 13.3953 5.50898 12.75 5.34375ZM12 9.75C11.7034 9.75 11.4133 9.66203 11.1667 9.4972C10.92 9.33238 10.7277 9.09811 10.6142 8.82403C10.5007 8.54994 10.471 8.24834 10.5288 7.95736C10.5867 7.66639 10.7296 7.39912 10.9394 7.18934C11.1491 6.97956 11.4164 6.8367 11.7074 6.77882C11.9984 6.72094 12.3 6.75065 12.574 6.86418C12.8481 6.97771 13.0824 7.16997 13.2472 7.41665C13.412 7.66332 13.5 7.95333 13.5 8.25C13.5 8.64782 13.342 9.02936 13.0607 9.31066C12.7794 9.59196 12.3978 9.75 12 9.75ZM21.75 15.75C21.7494 15.0849 21.5282 14.4388 21.121 13.9129C20.7139 13.387 20.1438 13.011 19.5 12.8438V3.75C19.5 3.55109 19.421 3.36032 19.2804 3.21967C19.1397 3.07902 18.9489 3 18.75 3C18.5511 3 18.3603 3.07902 18.2197 3.21967C18.079 3.36032 18 3.55109 18 3.75V12.8438C17.3547 13.009 16.7827 13.3843 16.3743 13.9105C15.9658 14.4367 15.7441 15.0839 15.7441 15.75C15.7441 16.4161 15.9658 17.0633 16.3743 17.5895C16.7827 18.1157 17.3547 18.491 18 18.6562V20.25C18 20.4489 18.079 20.6397 18.2197 20.7803C18.3603 20.921 18.5511 21 18.75 21C18.9489 21 19.1397 20.921 19.2804 20.7803C19.421 20.6397 19.5 20.4489 19.5 20.25V18.6562C20.1438 18.489 20.7139 18.113 21.121 17.5871C21.5282 17.0612 21.7494 16.4151 21.75 15.75ZM18.75 17.25C18.4534 17.25 18.1633 17.162 17.9167 16.9972C17.67 16.8324 17.4777 16.5981 17.3642 16.324C17.2507 16.0499 17.221 15.7483 17.2788 15.4574C17.3367 15.1664 17.4796 14.8991 17.6894 14.6893C17.8991 14.4796 18.1664 14.3367 18.4574 14.2788C18.7484 14.2209 19.05 14.2506 19.324 14.3642C19.5981 14.4777 19.8324 14.67 19.9972 14.9166C20.1621 15.1633 20.25 15.4533 20.25 15.75C20.25 16.1478 20.092 16.5294 19.8107 16.8107C19.5294 17.092 19.1478 17.25 18.75 17.25Z" fill="#3553FD"/>
            </svg>
          </button>
        </div>

        <div className={styles.rightSection}>
          <button
            className={styles.notificationBtn}
            title="Notifications"
            onClick={onNotificationClick}
            aria-label="View notifications"
          >
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20.9109 6.49958C20.7788 6.56707 20.6253 6.57963 20.4839 6.5345C20.3426 6.48937 20.2248 6.39022 20.1562 6.25864C19.4247 4.81416 18.317 3.59379 16.95 2.72614C16.8256 2.64576 16.7379 2.51957 16.7059 2.37494C16.674 2.23032 16.7004 2.07893 16.7794 1.95365C16.8584 1.82836 16.9836 1.73929 17.1279 1.70576C17.2721 1.67224 17.4238 1.69696 17.55 1.77458C19.0809 2.7539 20.3237 4.12292 21.1509 5.74114C21.1849 5.8067 21.2057 5.87832 21.2121 5.95191C21.2185 6.02551 21.2103 6.09963 21.188 6.17006C21.1657 6.24049 21.1297 6.30584 21.0822 6.36238C21.0347 6.41891 20.9765 6.46553 20.9109 6.49958ZM3.84371 6.25864C4.57524 4.81416 5.68291 3.59379 7.04996 2.72614C7.17436 2.64576 7.26205 2.51957 7.29398 2.37494C7.32592 2.23032 7.29952 2.07893 7.22052 1.95365C7.14153 1.82836 7.01631 1.73929 6.87204 1.70576C6.72777 1.67224 6.57611 1.69696 6.44996 1.77458C4.91902 2.7539 3.6762 4.12292 2.84902 5.74114C2.80764 5.80694 2.78035 5.88061 2.76887 5.95749C2.75738 6.03437 2.76196 6.1128 2.78231 6.18782C2.80266 6.26285 2.83834 6.33284 2.88709 6.39338C2.93585 6.45393 2.99662 6.50371 3.06558 6.53958C3.13454 6.57546 3.21019 6.59666 3.28775 6.60183C3.36531 6.607 3.4431 6.59605 3.51622 6.56965C3.58933 6.54325 3.65618 6.50199 3.71255 6.44845C3.76892 6.39493 3.81357 6.33029 3.84371 6.25864ZM20.625 16.588C20.7411 16.7868 20.8028 17.0127 20.8041 17.2429C20.8053 17.4732 20.7459 17.6997 20.632 17.8997C20.518 18.0997 20.3534 18.2663 20.1547 18.3826C19.956 18.4989 19.7302 18.5609 19.5 18.5624H15.5156C15.379 19.3963 14.9504 20.1544 14.3064 20.7015C13.6624 21.2485 12.8449 21.5489 12 21.5489C11.155 21.5489 10.3375 21.2485 9.69351 20.7015C9.04953 20.1544 8.62096 19.3963 8.48433 18.5624H4.49996C4.26925 18.5619 4.04275 18.5006 3.84327 18.3847C3.6438 18.2688 3.4784 18.1023 3.36375 17.9021C3.24911 17.7019 3.18926 17.475 3.19024 17.2443C3.19122 17.0136 3.25299 16.7872 3.36933 16.588C4.2309 15.1021 4.68746 12.9964 4.68746 10.4999C4.68746 8.56049 5.45788 6.70053 6.82924 5.32917C8.2006 3.95781 10.0606 3.18739 12 3.18739C13.9394 3.18739 15.7993 3.95781 17.1707 5.32917C18.542 6.70053 19.3125 8.56049 19.3125 10.4999C19.3125 13.0311 19.7568 15.0805 20.6325 16.588H20.625ZM14.3709 18.5624H9.62902C9.75623 19.0955 10.0594 19.5702 10.4896 19.9098C10.9198 20.2494 11.4519 20.4341 12 20.4341C12.548 20.4341 13.0801 20.2494 13.5103 19.9098C13.9405 19.5702 14.2437 19.0955 14.3709 18.5624ZM19.6603 17.1561C18.6834 15.4686 18.1875 13.2327 18.1875 10.4999C18.1875 8.85886 17.5356 7.28505 16.3752 6.12466C15.2148 4.96428 13.641 4.31239 12 4.31239C10.3589 4.31239 8.78512 4.96428 7.62474 6.12466C6.46435 7.28505 5.81246 8.85886 5.81246 10.4999C5.81246 13.2336 5.31652 15.4686 4.33965 17.1561C4.32319 17.1846 4.31453 17.217 4.31453 17.2499C4.31453 17.2828 4.32319 17.3151 4.33965 17.3436C4.35509 17.3724 4.37811 17.3963 4.40622 17.4128C4.43432 17.4293 4.46642 17.4378 4.49902 17.4374H19.5C19.5326 17.4378 19.5647 17.4293 19.5928 17.4128C19.6209 17.3963 19.6439 17.3724 19.6593 17.3436C19.6759 17.3152 19.6848 17.2829 19.6849 17.25C19.6851 17.2171 19.6766 17.1847 19.6603 17.1561Z" fill="#060B13"/>
            </svg>
          </button>

          {/* Desktop-only menu button */}
          <div className={styles.menuWrapper} ref={menuRef}>
            <button
              className={styles.menuBtn}
              title="Menu"
              aria-haspopup="menu"
              aria-expanded={isMenuOpen}
              onClick={() => setIsMenuOpen((v) => !v)}
            >
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 6H21" stroke="#0222D7" strokeWidth="2" strokeLinecap="round"/>
                <path d="M3 12H21" stroke="#0222D7" strokeWidth="2" strokeLinecap="round"/>
                <path d="M3 18H21" stroke="#0222D7" strokeWidth="2" strokeLinecap="round"/>
              </svg>
            </button>

            {isMenuOpen && (
              <div role="menu" className={styles.menuDropdown}>
                {navItems.map((item) => (
                  <button
                    key={item.id}
                    className={`${styles.menuItem} ${isActive(item.path) ? styles.menuItemActive : ''}`}
                    onClick={() => {
                      item.onClick();
                      setIsMenuOpen(false);
                    }}
                    role="menuitem"
                  >
                    <span className={styles.menuIcon}>{item.icon}</span>
                    <span className={styles.menuLabel}>{item.label}</span>
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default HomeHeader;